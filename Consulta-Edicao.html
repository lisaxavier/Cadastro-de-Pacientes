<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consulta e Edição</title>
  <style>
    :root{
      --bg:#0b0b0f; --panel:#121217; --text:#eaeaf0; --muted:#9aa0a6; --accent:#4cc9f0; --accent2:#b5179e;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
    a{color:var(--accent)}
    .topbar{
      display:flex;justify-content:space-between;align-items:center;
      padding:12px 18px 8px 18px;background:#0e0e13;
      border-bottom:1px solid #1f2230;
    }
    .topbar .brand{
      font-weight:700;font-size:1.3rem;letter-spacing:.3px;padding-top:2px;
    }
    .container{max-width:980px;margin:0 auto;padding:22px 10px 0 10px}
    .card{background:var(--panel);border:1px solid #1e2130;border-radius:16px;padding:18px;margin-top:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .grid-3{display:grid;grid-template-columns:2fr 1fr 1fr;gap:14px}
    label{display:flex;flex-direction:column;font-size:14px;color:var(--muted)}
    input,select,button{padding:12px;border-radius:10px;border:1px solid #2a2d3e;background:#151724;color:var(--text);width:100%}
    input:focus,select:focus{outline:2px solid var(--accent)}
    button{background:linear-gradient(90deg,var(--accent2),var(--accent));border:none;font-weight:700;cursor:pointer}
    button.ghost{background:transparent;border:1px solid #2a2d3e}
    button:hover{filter:brightness(1.05)}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid #23263a;padding:10px;text-align:left}
    th{color:var(--accent);}
    th.email-col, td.email-col { width:180px; min-width:120px; max-width:240px; word-break:break-all; }
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#1f2230;color:#cbd1d8;font-size:12px}
    .actions{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
    .msg-vazia {text-align:center;color:var(--accent);margin-top:30px;}
    .msg-sucesso {color: #40d29b; font-weight:bold; padding:6px 0;}
    .msg-erro {color: #ff6570; font-weight:bold; padding:6px 0;}
    .msg-sync {
      position: fixed;
      top: 16px; left: 0; right: 0; z-index: 2222;
      text-align: center;
      font-size: 1.1rem;
      font-weight:700;
      color: #3cf6a3;
      letter-spacing: .04em;
      text-shadow: 0 1px 22px #1079488e, 0 1px 2px #27392e;
      opacity: 1;
      pointer-events: none;
      user-select: none;
      transition:.6s opacity;
    }
    .msg-sync.hide { opacity: 0; }
    .bloqueio-overlay {
      position: fixed; left:0;top:0;right:0;bottom:0;
      background:rgba(30,35,40,0.09);
      z-index: 4000;
      pointer-events: all;
      cursor: progress;
      transition:.5s;
    }
    body.bloqueado, body.bloqueado * { cursor: progress !important; }
    @media(max-width:720px){
      .grid-2,.grid-3{grid-template-columns:1fr}
      .topbar .brand{font-size:1.02rem;}
      .msg-sync{font-size:0.82rem;top:10px;}
      th.email-col, td.email-col{width:88px;}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <span class="brand">Consulta e Edição</span>
    <span class="menu"></span>
  </div>
  <div id="msgSync" style="display:none"></div>
  <div id="bloqueioOverlay" class="bloqueio-overlay" style="display:none"></div>
  <main class="container">
    <div id="editorArea"></div>
    <div class="card">
      <div class="grid-3" style="margin-bottom:18px;">
        <input type="text" id="busca" placeholder="Buscar por nome, telefone ou email... (mín 3 caracteres)">
        <span></span>
        <button class="ghost" id="btnToggleTodos" onclick="toggleTodos()">Listar Todos</button>
      </div>
      <div id="msgBox"></div>
      <div id="listaPacientes"></div>
    </div>
  </main>
  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycby0WSHsCnmjaeAZHEsHhriHw2NP49Tsjj9p5JegnCaauTPKgtLeDQjDLWmB2UfNpidR/exec";
    let pacientes = [];
    let todosVisiveis = false;
    let editandoId = null;

    const listaDiv = document.getElementById('listaPacientes');
    const busca = document.getElementById('busca');
    const btnToggleTodos = document.getElementById('btnToggleTodos');
    const msgBox = document.getElementById('msgBox');
    const msgSync = document.getElementById('msgSync');
    const bloqueioOverlay = document.getElementById('bloqueioOverlay');

    function bloquearPagina(sim) {
      if (sim) {
        document.body.classList.add('bloqueado');
        bloqueioOverlay.style.display = "block";
      } else {
        document.body.classList.remove('bloqueado');
        bloqueioOverlay.style.display = "none";
      }
    }

    function exibirMsgSync() {
      msgSync.innerHTML = `<span class="msg-sync">Sincronizado com Banco de dados online</span>`;
      msgSync.style.display = "block";
      setTimeout(() => {
        msgSync.firstChild.classList.add("hide");
        setTimeout(()=>{msgSync.style.display="none";}, 600);
      }, 1200);
    }

    function formatarDataIso(d) {
      if (!d) return "";
      if (typeof d === 'string' && d.match(/^\d{4}-\d{2}-\d{2}/)) return d.slice(0,10);
      let data = new Date(d);
      if (!isNaN(data)) return data.toISOString().slice(0,10);
      return "";
    }
    function formatarDataBr(d) {
      if (!d) return "";
      let data = new Date(d);
      if (!isNaN(data)) return data.toLocaleDateString('pt-BR');
      if (typeof d === 'string' && /\d{4}-\d{2}-\d{2}/.test(d)) return d.split('-').reverse().join('/');
      return d;
    }

    function showOrientMsg() {
      listaDiv.innerHTML = `<div class="msg-vazia">Digite pelo menos 3 caracteres na busca, ou clique 'Listar Todos'.</div>`;
    }

    function listarPacientes() {
      bloquearPagina(true);
      msgBox.textContent = "";
      fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({acao: "listar"})
      })
        .then(r => r.json())
        .then(lista => {
          pacientes = lista;
          bloquearPagina(false);
          exibirMsgSync();
          if (busca.value && busca.value.trim().length>=3) filtrarEmTempoReal();
          else showOrientMsg();
        })
        .catch(e => {
          bloquearPagina(false);
          msgBox.innerHTML = `<span class="msg-erro">Não foi possível carregar dados: ${e.message}</span>`;
        });
    }

    function filtrarEmTempoReal() {
      let termo = (busca.value || '').trim();
      limpaEditor();
      if (termo.length < 3) {
        showOrientMsg();
        return;
      }

      let resultados = [];
      if (/^[A-ZÁÉÍÓÚÃÕÂÊÎÔÛÀÈÌÒÙÇ]/.test(termo)) {
        resultados = pacientes.filter(p =>
          (p.nome || "").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()
            .includes(termo.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase())
        );
      } else if (/^\d+$/.test(termo)) {
        resultados = pacientes.filter(p =>
          (String(p.telefone) || "").replace(/\D/g,"").includes(termo.replace(/\D/g,""))
        );
      } else if (termo.includes("@") && termo === termo.toLowerCase()) {
        resultados = pacientes.filter(p => (p.email || "").toLowerCase().includes(termo));
      }
      renderTabela(resultados);
      todosVisiveis = false;
      btnToggleTodos.textContent = "Listar Todos";
    }

    busca.addEventListener('input', filtrarEmTempoReal);

    function toggleTodos() {
      todosVisiveis = !todosVisiveis;
      limpaEditor();
      if (todosVisiveis) {
        renderTabela(pacientes);
        btnToggleTodos.textContent = "Esconder Todos";
        busca.value = '';
      } else {
        showOrientMsg();
        btnToggleTodos.textContent = "Listar Todos";
      }
    }

    // FUNÇÃO CORRIGIDA: utiliza array + .map + .join("") para as linhas
    function renderTabela(lista) {
      if (!lista || lista.length === 0) {
        listaDiv.innerHTML = `<div class="msg-vazia">Nenhuma informação encontrada.</div>`;
        return;
      }
      let linhas = lista.map((p,ix) => `
        <tr id="pac_${p.id}">
          <td>${p.local||""}</td>
          <td>${p.nome||""}</td>
          <td>${p.telefone||""}</td>
          <td class="email-col">${p.email||""}</td>
          <td>${formatarDataBr(p.diaRX)||""}</td>
          <td>${p.hora||""}</td>
          <td>${p.valor||""}</td>
          <td>${p.presente||""}</td>
          <td>
            <button class="ghost btnEditar" data-id="${p.id}">Editar</button>
          </td>
        </tr>`);
      let t = `<table>
        <thead>
          <tr>
            <th>Local</th>
            <th>Nome</th>
            <th>Telefone</th>
            <th class="email-col">Email</th>
            <th>Dia RX</th>
            <th>Hora</th>
            <th>Valor (R$)</th>
            <th>Presente</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          ${linhas.join("")}
        </tbody>
      </table>`;
      listaDiv.innerHTML = t;
    }

    // >>> DELEGAÇÃO DE EVENTOS PARA O BOTÃO EDITAR <<<
    listaDiv.addEventListener('click', function(e){
      const btn = e.target;
      if(btn.classList.contains('btnEditar')){
        const id = btn.getAttribute('data-id');
        abrirEditor(id);
      }
    });

    function abrirEditor(id) {
      limpaEditor();
      editandoId = id;
      const p = pacientes.find(x => String(x.id) === String(id));
      if (!p) return;
      document.getElementById('editorArea').innerHTML = `
        <div class="card">
          <h3>Editar Paciente</h3>
          <div class="grid-3">
            <label>Local
              <select id="editLocal">
                <option${(p.local=="Alegre")?" selected":""}>Alegre</option>
                <option${(p.local=="Carmelo")?" selected":""}>Carmelo</option>
                <option${(p.local=="Juliana")?" selected":""}>Juliana</option>
              </select>
            </label>
            <label>Nome <input id="editNome" value="${(p.nome || "").toUpperCase()}" maxlength="80" autocomplete="off"></label>
            <label>Telefone <input id="editTel" value="${mascaraTelefone(p.telefone)}" maxlength="16" autocomplete="off"></label>
          </div>
          <div class="grid-3" style="margin-top:10px;">
            <label>Email <input id="editMail" value="${(p.email || "").toLowerCase()}" maxlength="80" autocomplete="off"></label>
            <label>Dia RX <input id="editRx" type="date" value="${formatarDataIso(p.diaRX) || ''}"></label>
            <label>Hora <input id="editHora" type="time" value="${p.hora || ''}"></label>
          </div>
          <div class="grid-3" style="margin-top:10px;">
            <label>Valor <input id="editVal" value="${p.valor || ""}"></label>
            <label>Presente
              <select id="editPres">
                <option${(p.presente || "").toLowerCase() === "sim" ? " selected" : ""}>Sim</option>
                <option${(p.presente || "").toLowerCase() === "não" ? " selected" : ""}>Não</option>
              </select>
            </label>
            <span></span>
          </div>
          <div class="actions">
            <button onclick="salvarEditor('${p.id}')">Salvar alterações</button>
            <button class="ghost" onclick="limpaEditor()">Cancelar</button>
          </div>
        </div>
      `;
      // Nome em MAISÚSCULO
      document.getElementById('editNome').addEventListener('input',function(e){
          this.value=this.value.toUpperCase();
      });
      // Email só minúsculo
      document.getElementById('editMail').addEventListener('input',function(e){
          this.value=this.value.replace(/[A-Z]/g, '').toLowerCase();
      });
      // Telefone com máscara
      document.getElementById('editTel').addEventListener('input',function(e){
          let val = this.value.replace(/\D/g,'');
          this.value=mascaraTelefone(val);
      });
      setTimeout(() => { document.getElementById('editLocal').focus(); }, 100);
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function mascaraTelefone(v){
      v = (v||'').replace(/\D/g,'');
      if(!v) return '';
      v = v.replace(/^(\d{2})(\d?)(\d{4})(\d{4})/, '($1) $2 $3-$4');
      if(v.length === 15) return v;
      if(v.length>10) return v.replace(/^(\d{2})(\d{5})(\d{4})/,'($1) $2-$3');
      return v.replace(/^(\d{2})(\d{4,5})(\d{0,4})/,'($1) $2-$3').replace(/-$/,'');
    }

    function salvarEditor(id) {
      const p = pacientes.find(x => String(x.id) === String(id));
      if (!p) return;
      const dados = {
        acao: "editar",
        id: id,
        local: document.getElementById('editLocal').value.trim(),
        nome: document.getElementById('editNome').value.trim(),
        telefone: document.getElementById('editTel').value.trim(),
        email: document.getElementById('editMail').value.trim(),
        diaRX: document.getElementById('editRx').value,
        hora: document.getElementById('editHora').value,
        valor: document.getElementById('editVal').value.trim(),
        presente: document.getElementById('editPres').value
      };
      bloquearPagina(true);
      fetch(API_URL, {
        method: "POST",
        body: JSON.stringify(dados)
      })
        .then(r => r.text())
        .then(msg => {
          msgBox.innerHTML = `<span class="msg-sucesso">${msg}</span>`;
          limpaEditor();
          listarPacientes();
        })
        .catch(e => {
          msgBox.innerHTML = `<span class="msg-erro">Erro ao editar: ${e.message}</span>`;
          bloquearPagina(false);
        });
    }

    function limpaEditor() {
      document.getElementById('editorArea').innerHTML = '';
      editandoId = null;
    }

    // Inicial ao abrir
    showOrientMsg();
    listarPacientes();

  </script>
</body>
</html>
